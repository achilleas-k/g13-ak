package device_test

import (
	"testing"

	"github.com/achilleas-k/g13-ak/internal/device"
	"github.com/stretchr/testify/assert"
)

type testData struct {
	data     []byte
	keyNames []string
}

var (
	// short sequence of recorded data from device
	smallDataSet = []testData{
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x1, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{"G1"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x2, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{"G2"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x4, 0x80, 0x0, 0x0},
			keyNames: []string{"G11"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x40, 0x80, 0x0, 0x0},
			keyNames: []string{"G15"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x40, 0x80, 0x0, 0x80},
			keyNames: []string{"G15"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x40, 0x80, 0x0, 0x80},
			keyNames: []string{"G15"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x90, 0x0, 0x80},
			keyNames: []string{"G21"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x2},
			keyNames: []string{"LEFT"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
	}

	// (almost) all buttons pressed and released sequentially
	allButtons = []testData{
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x1, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{"G1"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x2, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{"G2"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x4, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{"G3"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x8, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{"G4"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x10, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{"G5"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x20, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{"G6"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x40, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{"G7"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x80, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{"G8"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x1, 0x80, 0x0, 0x0},
			keyNames: []string{"G9"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x2, 0x80, 0x0, 0x80},
			keyNames: []string{"G10"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x4, 0x80, 0x0, 0x0},
			keyNames: []string{"G11"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x8, 0x80, 0x0, 0x80},
			keyNames: []string{"G12"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x10, 0x80, 0x0, 0x0},
			keyNames: []string{"G13"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x20, 0x80, 0x0, 0x80},
			keyNames: []string{"G14"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x40, 0x80, 0x0, 0x0},
			keyNames: []string{"G15"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x80, 0x80, 0x0, 0x0},
			keyNames: []string{"G16"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x81, 0x0, 0x0},
			keyNames: []string{"G17"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x82, 0x0, 0x0},
			keyNames: []string{"G18"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x84, 0x0, 0x0},
			keyNames: []string{"G19"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x88, 0x0, 0x80},
			keyNames: []string{"G20"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x90, 0x0, 0x80},
			keyNames: []string{"G21"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0xa0, 0x0, 0x80},
			keyNames: []string{"G22"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x1, 0x80},
			keyNames: []string{"BD"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x2, 0x80},
			keyNames: []string{"L1"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x4, 0x0},
			keyNames: []string{"L2"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x8, 0x80},
			keyNames: []string{"L3"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x10, 0x0},
			keyNames: []string{"L4"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x20, 0x80},
			keyNames: []string{"M1"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x40, 0x0},
			keyNames: []string{"M2"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x80, 0x80},
			keyNames: []string{"M3"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x81},
			keyNames: []string{"MR"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x2},
			keyNames: []string{"LEFT"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x0},
			keyNames: []string{},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x4},
			keyNames: []string{"DOWN"},
		},
		{
			data:     []byte{0x1, 0x7f, 0x70, 0x0, 0x0, 0x80, 0x0, 0x80},
			keyNames: []string{},
		},
	}
)

func TestButtonIdentification(t *testing.T) {
	assert := assert.New(t)
	for idx, testItem := range smallDataSet {
		data := testItem.data
		expectedKeyNames := testItem.keyNames

		var decodedKeyNames []string
		for _, key := range device.AllKeys() {
			if key.Uint64()&device.MaskDataForInput(device.BtoiLE(data)) != 0 {
				// key is pressed
				decodedKeyNames = append(decodedKeyNames, key.String())
			}
		}
		assert.ElementsMatch(expectedKeyNames, decodedKeyNames, "smallDataSet[%d]: %#v", idx, data)
	}

	for idx, testItem := range allButtons {
		data := testItem.data
		expectedKeyNames := testItem.keyNames

		var decodedKeyNames []string
		for _, key := range device.AllKeys() {
			if key.Uint64()&device.MaskDataForInput(device.BtoiLE(data)) != 0 {
				// key is pressed
				decodedKeyNames = append(decodedKeyNames, key.String())
			}
		}
		assert.ElementsMatch(expectedKeyNames, decodedKeyNames, "allButtons[%d]: %#v", idx, data)
	}
}
